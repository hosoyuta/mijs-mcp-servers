# J-Quants MCP Server 要件定義書

## 概要

J-Quants APIを活用したMCPサーバーを構築し、Claude等のAIアシスタントから日本株の株価・財務情報を取得できるようにする。本プロジェクトはMIJS 2025年秋合宿の教育目的プロジェクトの一環として開発する。

## 関連文書

- **ユーザストーリー**: [📖 j-quants-user-stories.md](j-quants-user-stories.md)
- **受け入れ基準**: [✅ j-quants-acceptance-criteria.md](j-quants-acceptance-criteria.md)
- **元要件定義**: [📄 ../REQUIREMENTS.md](../REQUIREMENTS.md)

## 機能要件（EARS記法）

**【信頼性レベル凡例】**:
- 🔵 **青信号**: 既存REQUIREMENTS.md・技術スタック・ユーザーヒアリングを参考にした確実な要件
- 🟡 **黄信号**: 既存資料から妥当な推測による要件
- 🔴 **赤信号**: 既存資料にない推測による要件

### 通常要件（SHALL）

#### 認証・接続

- REQ-001: システムは起動時にJ-Quants APIへの認証を実行しなければならない 🔵 *REQUIREMENTS.md 6.2認証フローより*
- REQ-002: システムはリフレッシュトークンを使用してIDトークンを取得しなければならない 🔵 *REQUIREMENTS.md 6.2認証フローより*
- REQ-003: システムは取得したIDトークンをJSONファイルにキャッシュしなければならない 🔵 *REQUIREMENTS.md 6.4 + ユーザーヒアリング: 認証トークンのみキャッシュ*
- REQ-004: システムはAPIリクエスト時にIDトークンをAuthorizationヘッダーに付与しなければならない 🔵 *REQUIREMENTS.md 6.2認証フローより*

#### 上場銘柄情報取得（get_listed_companies）

- REQ-101: システムは上場銘柄一覧を取得するMCPツール `get_listed_companies` を提供しなければならない 🔵 *REQUIREMENTS.md 4.1 Phase 1*
- REQ-102: システムは取得した銘柄一覧に銘柄コード、会社名、市場区分、業種を含めなければならない 🔵 *REQUIREMENTS.md 5.1出力仕様より*

#### 株価情報取得（get_stock_price）

- REQ-201: システムは指定銘柄の株価データを取得するMCPツール `get_stock_price` を提供しなければならない 🔵 *REQUIREMENTS.md 4.1 Phase 1*
- REQ-202: システムは株価データに始値・高値・安値・終値・出来高を含めなければならない 🔵 *REQUIREMENTS.md 5.2出力仕様より*
- REQ-203: システムは株価データを日付降順（新しい順）で返却しなければならない 🟡 *一般的なAPI仕様から妥当な推測*

#### 財務諸表取得（get_financial_statements）

- REQ-301: システムは指定銘柄の財務諸表を取得するMCPツール `get_financial_statements` を提供しなければならない 🔵 *REQUIREMENTS.md 4.1 Phase 1*
- REQ-302: システムは財務諸表に貸借対照表・損益計算書・キャッシュフロー計算書を含めなければならない 🔵 *REQUIREMENTS.md 5.3出力仕様より*

#### 企業情報取得（get_company_info）

- REQ-401: システムは指定銘柄の企業詳細情報を取得するMCPツール `get_company_info` を提供しなければならない 🔵 *REQUIREMENTS.md 4.1 Phase 1*
- REQ-402: システムは企業情報に銘柄コード、会社名、市場区分、業種、最新株価を含めなければならない 🔵 *REQUIREMENTS.md 5.4出力仕様より*

### 条件付き要件（WHEN/IF-THEN）

#### パラメータ処理

- REQ-501: 市場区分パラメータが指定された場合、システムは指定された市場の銘柄のみを返却しなければならない 🔵 *REQUIREMENTS.md 5.1入力パラメータより*
- REQ-502: 業種コードパラメータが指定された場合、システムは指定された業種の銘柄のみを返却しなければならない 🔵 *REQUIREMENTS.md 5.1入力パラメータより*
- REQ-503: 取得開始日パラメータが指定された場合、システムは指定日以降の株価データを返却しなければならない 🔵 *REQUIREMENTS.md 5.2入力パラメータより*
- REQ-504: 取得終了日パラメータが指定された場合、システムは指定日以前の株価データを返却しなければならない 🔵 *REQUIREMENTS.md 5.2入力パラメータより*

#### エラーハンドリング

- REQ-601: API呼び出しが一時的エラーで失敗した場合、システムは最大3回まで自動的に再試行しなければならない 🔵 *ユーザーヒアリング: 自動リトライ選択*
- REQ-602: API呼び出しが失敗した場合、システムはエラー内容をログファイルに記録しなければならない 🔵 *ユーザーヒアリング: ログ記録選択*
- REQ-603: APIリクエストが5秒以内に完了しない場合、システムはタイムアウトエラーを返却しなければならない 🔵 *ユーザーヒアリング: 5秒以内の許容範囲*
- REQ-604: 認証トークンの有効期限が切れた場合、システムは自動的にトークンを再取得しなければならない 🔵 *REQUIREMENTS.md 6.3エラーハンドリングより*
- REQ-605: レート制限エラーが発生した場合、システムは適切な待機時間後に再試行しなければならない 🔵 *REQUIREMENTS.md 6.3エラーハンドリングより*

#### バリデーション

- REQ-701: 必須パラメータが未指定の場合、システムは分かりやすいエラーメッセージを返却しなければならない 🔵 *ユーザーヒアリング: 最低限のバリデーション*

### 状態要件（WHERE）

- REQ-801: フリープランの制約下にある場合、システムは直近12週間のデータを取得しようとした際にエラーメッセージを返却しなければならない 🔵 *REQUIREMENTS.md 2.3フリープランの制約より*
- REQ-802: フリープランの制約下にある場合、システムは過去2年以前のデータを取得しようとした際にエラーメッセージを返却しなければならない 🔵 *REQUIREMENTS.md 2.3フリープランの制約より*

### オプション要件（MAY）

- REQ-901: システムはデバッグモードでAPIリクエスト・レスポンスの詳細をログ出力してもよい 🟡 *開発効率向上のための推測*
- REQ-902: システムはAPIレスポンスタイムを計測して表示してもよい 🟡 *パフォーマンス監視のための推測*

### 制約要件（MUST）

#### 技術制約

- REQ-1001: システムはTypeScript 5.x + Node.js 20 LTSで実装しなければならない 🔵 *tech-stack.md コア技術より*
- REQ-1002: システムは@modelcontextprotocol/sdk を使用してMCPサーバーを実装しなければならない 🔵 *tech-stack.md MCPフレームワークより*
- REQ-1003: システムはJSONファイルベースでトークンを保存しなければならない 🔵 *tech-stack.md データストレージ + ユーザーヒアリング*
- REQ-1004: システムはローカル環境でのみ動作しなければならない 🔵 *tech-stack.md デプロイ先より*

#### セキュリティ制約

- REQ-1101: システムはAPIキー・リフレッシュトークンを環境変数（.env）から読み込まなければならない 🔵 *REQUIREMENTS.md 8.2技術的制約より*
- REQ-1102: システムは.envファイルを.gitignoreに含めなければならない 🔵 *REQUIREMENTS.md 8.2技術的制約 + tech-stack.md セキュリティより*
- REQ-1103: システムは個人情報を扱ってはならない 🔵 *tech-stack.md セキュリティ方針より*

#### データ制約

- REQ-1201: システムはフリープランの12週間遅延制約を前提として動作しなければならない 🔵 *REQUIREMENTS.md 2.3フリープランの制約より*
- REQ-1202: システムは過去2年分のデータのみアクセス可能であることを前提として動作しなければならない 🔵 *REQUIREMENTS.md 2.3フリープランの制約より*

## 非機能要件

### パフォーマンス

- NFR-001: システムは1つのAPIリクエストを5秒以内に完了しなければならない 🔵 *ユーザーヒアリング: 5秒以内の許容範囲*
- NFR-002: システムは起動時の認証処理を10秒以内に完了しなければならない 🟡 *REQ-001から妥当な推測*
- NFR-003: システムはメモリ使用量を500MB以下に抑えなければならない 🟡 *ローカル環境・軽負荷から妥当な推測*

### 可用性

- NFR-101: システムはAPI接続失敗時も正常終了しなければならない 🔵 *教育目的・エラーハンドリング要件より*
- NFR-102: システムはネットワークエラー時にクラッシュしてはならない 🔵 *教育目的・安定性要件より*

### 保守性

- NFR-201: システムはTypeScript strict modeで型安全性を確保しなければならない 🔵 *tech-stack.md コード品質基準より*
- NFR-202: システムはESLintエラー0件を維持しなければならない 🔵 *tech-stack.md コード品質基準より*
- NFR-203: システムは複雑なロジックに適切なコメントを記載しなければならない 🔵 *tech-stack.md ドキュメント基準より*

### ユーザビリティ

- NFR-301: システムはエラーメッセージを日本語で分かりやすく表示しなければならない 🔵 *ユーザーヒアリング: エラーメッセージ返却 + 日本向けプロジェクト*
- NFR-302: システムはMCPツールの説明を日本語で提供しなければならない 🟡 *日本向けプロジェクトから妥当な推測*

### テスト容易性

- NFR-401: システムはテスト実行時にモックデータで動作可能でなければならない 🟡 *tech-stack.md テスト基準から妥当な推測*

## Edgeケース

### エラー処理

- EDGE-001: 銘柄コードが存在しない場合、システムは「指定された銘柄コード（XXXX）は存在しません」というエラーを返却する 🟡 *バリデーション要件から妥当な推測*
- EDGE-002: 日付フォーマットが不正な場合、システムは「日付はYYYY-MM-DD形式で指定してください」というエラーを返却する 🟡 *バリデーション要件から妥当な推測*
- EDGE-003: APIキーが未設定の場合、システムは「環境変数 J_QUANTS_REFRESH_TOKEN を設定してください」というエラーを返却する 🔵 *REQ-1101から導出*

### 境界値

- EDGE-101: データ取得期間が2年を超える場合、システムは過去2年分のみを取得して警告メッセージを表示する 🟡 *REQ-1202から妥当な推測*
- EDGE-102: 取得開始日が取得終了日より未来の場合、システムは「取得開始日は取得終了日より前の日付を指定してください」というエラーを返却する 🟡 *一般的なバリデーションから推測*

### ネットワーク異常

- EDGE-201: J-Quants APIがメンテナンス中の場合、システムは「J-Quants APIがメンテナンス中です。しばらく時間をおいてから再試行してください」というエラーを返却する 🟡 *REQ-602から妥当な推測*
- EDGE-202: インターネット接続が切断されている場合、システムは「ネットワークに接続できません。インターネット接続を確認してください」というエラーを返却する 🟡 *REQ-602から妥当な推測*

### データ異常

- EDGE-301: APIレスポンスがJSONとしてパース不可能な場合、システムは「APIレスポンスの形式が不正です」というエラーを返却する 🟡 *エラーハンドリングから推測*
- EDGE-302: APIレスポンスに必須フィールドが欠けている場合、システムは「APIレスポンスに必要なデータが含まれていません」というエラーを返却する 🟡 *エラーハンドリングから推測*

## 開発フェーズとスコープ

### Phase 1: MVP（優先度: 高）

**実装期間**: 1週間

**スコープ**:
- 認証機能（REQ-001～REQ-004）
- 4つのMCPツール（REQ-101, REQ-201, REQ-301, REQ-401）
- 基本的なエラーハンドリング（REQ-601, REQ-602, REQ-604）
- 最低限のバリデーション（REQ-701）

### Phase 2: 拡張機能（優先度: 中）

**実装期間**: 1週間

**スコープ**:
- 検索機能（search_companies）
- 配当情報取得（get_dividend_info）
- 取引カレンダー取得（get_trading_calendar）
- 業種別銘柄一覧（get_sector_stocks）
- 詳細なエラーメッセージ（EDGE-001～EDGE-302）

### Phase 3: 高度な分析（優先度: 低・オプション）

**実装期間**: オプション

**スコープ**:
- 信用取引残高取得（get_margin_trading）
- 空売り情報取得（get_short_selling）
- 投資部門別売買状況（get_investment_breakdown）
- TOPIX指数データ（get_topix_data）
- パフォーマンス最適化

## 前提条件

1. ユーザーはJ-Quants APIのフリープランに登録済みである
2. ユーザーはリフレッシュトークンを取得済みである
3. ユーザーはNode.js 20 LTS以上をインストール済みである
4. ユーザーはnpmコマンドを使用できる環境を持っている

## 制約事項

### ビジネス制約

1. フリープランのため、直近12週間のデータは取得不可
2. フリープランのため、過去2年以前のデータは取得不可
3. J-Quants APIの利用規約を遵守すること
4. 商用利用の場合は有償プランへの移行が必要

### 技術制約

1. ローカル環境でのみ動作（デプロイ不要）
2. 認証は最低限の実装（教育目的）
3. データ永続化はJSONファイルのみ
4. テストカバレッジは任意（教育目的）

### 運用制約

1. 教育目的のプロジェクトであり、本番環境での使用は想定しない
2. 個人情報を扱わない
3. APIキーは公開リポジトリにコミットしない

## 参考資料

- J-Quants API公式サイト: https://jpx-jquants.com/
- J-Quants API日本語ドキュメント: https://jpx.gitbook.io/j-quants-ja
- MCP公式ドキュメント: https://modelcontextprotocol.io/
- TypeScript SDK: https://github.com/modelcontextprotocol/typescript-sdk
- プロジェクト技術スタック: [../../../docs/tech-stack.md](../../../docs/tech-stack.md)

## 更新履歴

- 2025-10-29: 初版作成（kairo-requirements コマンドによりEARS記法で作成）
  - 既存REQUIREMENTS.mdをベースにEARS記法で詳細化
  - ユーザーヒアリングによる追加要件の反映
  - 信頼性レベル（🔵🟡🔴）の明記
