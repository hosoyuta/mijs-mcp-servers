# J-Quants MCP Server 受け入れ基準

## 概要

このドキュメントはJ-Quants MCP Server機能の受け入れ基準とテスト項目を記載します。

## 機能テスト基準

**【信頼性レベル凡例】**:
- 🔵 **青信号**: REQUIREMENTS.md・技術スタック・ユーザーヒアリングを参考にした確実なテスト基準
- 🟡 **黄信号**: 既存資料から妥当な推測によるテスト基準
- 🔴 **赤信号**: 既存資料にない推測によるテスト基準

---

### REQ-001～REQ-004: 認証機能の受け入れ基準 🔵 *REQUIREMENTS.md 6.2認証フローより*

**Given（前提条件）**:
- J-Quants APIのフリープランに登録済み
- リフレッシュトークンを`.env`ファイルに設定済み
- インターネット接続が可能

**When（実行条件）**:
- MCPサーバーを起動する
- J-Quants APIへの認証を実行する

**Then（期待結果）**:
- リフレッシュトークンでIDトークンが取得される
- IDトークンがJSONファイル（`data/token.json`）にキャッシュされる
- APIリクエスト時にIDトークンがAuthorizationヘッダーに付与される
- 認証成功のログが出力される

**テストケース**:
- [ ] 正常系: リフレッシュトークンが有効な場合、認証が成功する
- [ ] 異常系: リフレッシュトークンが無効な場合、分かりやすいエラーメッセージが表示される
- [ ] 異常系: `.env`ファイルにリフレッシュトークンが未設定の場合、「環境変数 J_QUANTS_REFRESH_TOKEN を設定してください」というエラーが表示される
- [ ] 境界値: トークンの有効期限が切れた場合、自動的に再取得される

---

### REQ-101, REQ-102: get_listed_companies の受け入れ基準 🔵 *REQUIREMENTS.md 5.1より*

**Given（前提条件）**:
- MCPサーバーが起動済み
- 認証が完了済み

**When（実行条件）**:
- `get_listed_companies` MCPツールを呼び出す
- パラメータなし、または市場区分・業種コードを指定

**Then（期待結果）**:
- 上場銘柄一覧が返却される
- 各銘柄に以下の情報が含まれる:
  - 銘柄コード（code）
  - 会社名（name）
  - 市場区分（market）
  - 業種（sector）
  - 業種コード（sector_code）
- レスポンス時間が5秒以内

**テストケース**:
- [ ] 正常系: パラメータなしで全銘柄が取得できる
- [ ] 正常系: 市場区分（"プライム"）を指定した場合、プライム市場の銘柄のみが返却される
- [ ] 正常系: 業種コードを指定した場合、該当業種の銘柄のみが返却される
- [ ] 正常系: 市場区分と業種コードの両方を指定した場合、AND条件で絞り込まれる
- [ ] 異常系: API呼び出し失敗時、最大3回リトライされる
- [ ] 異常系: 3回リトライ後も失敗する場合、エラーメッセージが表示される
- [ ] 境界値: 銘柄数が0件の場合、空の配列が返却される

---

### REQ-201, REQ-202, REQ-203: get_stock_price の受け入れ基準 🔵 *REQUIREMENTS.md 5.2より*

**Given（前提条件）**:
- MCPサーバーが起動済み
- 認証が完了済み
- 有効な銘柄コードを把握している（例: "7203"）

**When（実行条件）**:
- `get_stock_price` MCPツールを呼び出す
- `code`パラメータに銘柄コードを指定
- オプションで`from_date`、`to_date`を指定

**Then（期待結果）**:
- 指定銘柄の株価データが返却される
- 各株価データに以下の情報が含まれる:
  - 日付（date）
  - 始値（open）
  - 高値（high）
  - 安値（low）
  - 終値（close）
  - 出来高（volume）
- 株価データが日付降順（新しい順）で並んでいる
- レスポンス時間が5秒以内

**テストケース**:
- [ ] 正常系: 銘柄コードのみ指定した場合、過去2年分（12週間遅延）の株価が取得できる
- [ ] 正常系: `from_date`を指定した場合、指定日以降の株価が取得できる
- [ ] 正常系: `to_date`を指定した場合、指定日以前の株価が取得できる
- [ ] 正常系: `from_date`と`to_date`の両方を指定した場合、期間内の株価が取得できる
- [ ] 正常系: 株価データが日付降順（新しい順）で返却される
- [ ] 異常系: 銘柄コードが未指定の場合、「銘柄コード（code）は必須パラメータです」というエラーが表示される
- [ ] 異常系: 存在しない銘柄コード（例: "9999"）を指定した場合、「指定された銘柄コード（9999）は存在しません」というエラーが表示される（🟡 *バリデーション要件から推測*）
- [ ] 異常系: 日付フォーマットが不正な場合、「日付はYYYY-MM-DD形式で指定してください」というエラーが表示される（🟡 *バリデーション要件から推測*）
- [ ] 境界値: 取得開始日が取得終了日より未来の場合、「取得開始日は取得終了日より前の日付を指定してください」というエラーが表示される（🟡 *一般的なバリデーションから推測*）
- [ ] 境界値: データ取得期間が2年を超える場合、過去2年分のみを取得して警告メッセージが表示される（🟡 *REQ-1202から推測*）

---

### REQ-301, REQ-302: get_financial_statements の受け入れ基準 🔵 *REQUIREMENTS.md 5.3より*

**Given（前提条件）**:
- MCPサーバーが起動済み
- 認証が完了済み
- 有効な銘柄コードを把握している
- 対象企業が財務諸表を開示している

**When（実行条件）**:
- `get_financial_statements` MCPツールを呼び出す
- `code`パラメータに銘柄コードを指定
- オプションで`statement_type`（"BS", "PL", "CF", "ALL"）を指定

**Then（期待結果）**:
- 指定銘柄の財務諸表データが返却される
- 貸借対照表（balance_sheet）に以下の情報が含まれる:
  - 総資産（total_assets）
  - 総負債（total_liabilities）
  - 純資産（net_assets）
- 損益計算書（profit_loss）に以下の情報が含まれる:
  - 売上高（revenue）
  - 営業利益（operating_income）
  - 純利益（net_income）
- キャッシュフロー計算書（cash_flow）に以下の情報が含まれる:
  - 営業CF（operating_cf）
  - 投資CF（investing_cf）
  - 財務CF（financing_cf）
- レスポンス時間が5秒以内

**テストケース**:
- [ ] 正常系: `statement_type`を指定しない場合、BS・PL・CF全てが取得できる
- [ ] 正常系: `statement_type="BS"`を指定した場合、貸借対照表のみが取得できる
- [ ] 正常系: `statement_type="PL"`を指定した場合、損益計算書のみが取得できる
- [ ] 正常系: `statement_type="CF"`を指定した場合、キャッシュフロー計算書のみが取得できる
- [ ] 異常系: 銘柄コードが未指定の場合、エラーメッセージが表示される
- [ ] 異常系: 財務諸表を開示していない企業の場合、「財務諸表データが見つかりません」というエラーが表示される（🟡 *エラーハンドリングから推測*）

---

### REQ-401, REQ-402: get_company_info の受け入れ基準 🔵 *REQUIREMENTS.md 5.4より*

**Given（前提条件）**:
- MCPサーバーが起動済み
- 認証が完了済み
- 有効な銘柄コードを把握している

**When（実行条件）**:
- `get_company_info` MCPツールを呼び出す
- `code`パラメータに銘柄コードを指定

**Then（期待結果）**:
- 指定銘柄の企業情報が返却される
- 以下の情報が含まれる:
  - 銘柄コード（code）
  - 会社名（name）
  - 市場区分（market）
  - 業種（sector）
  - 最新株価（latest_price）:
    - 日付（date）
    - 終値（close）
    - 前日比（change）
    - 変動率（change_percent）
- レスポンス時間が5秒以内

**テストケース**:
- [ ] 正常系: 銘柄コードを指定した場合、企業情報と最新株価が取得できる
- [ ] 正常系: 最新株価に前日比・変動率が計算されている
- [ ] 異常系: 銘柄コードが未指定の場合、エラーメッセージが表示される
- [ ] 異常系: 存在しない銘柄コードの場合、エラーメッセージが表示される

---

### REQ-601, REQ-602: エラーハンドリングの受け入れ基準 🔵 *ユーザーヒアリング: 自動リトライ・ログ記録*

**Given（前提条件）**:
- MCPサーバーが起動済み
- 認証が完了済み

**When（実行条件）**:
- API呼び出しが一時的エラーで失敗する
- または恒久的エラーで失敗する

**Then（期待結果）**:
- 一時的エラーの場合、最大3回まで自動的に再試行される
- エラー内容が`logs/`ディレクトリのログファイルに記録される
- ユーザーには分かりやすいエラーメッセージが表示される

**テストケース**:
- [ ] 正常系: 一時的エラー（503 Service Unavailable）の場合、3回リトライされる
- [ ] 正常系: 2回目のリトライで成功した場合、正常なレスポンスが返却される
- [ ] 正常系: エラー発生時、ログファイルにエラー詳細（時刻、エンドポイント、エラーメッセージ）が記録される
- [ ] 異常系: 3回リトライ後も失敗する場合、「APIへの接続に失敗しました。しばらく時間をおいて再試行してください」というエラーが表示される
- [ ] 異常系: レート制限エラー（429 Too Many Requests）の場合、適切な待機時間後に再試行される
- [ ] 異常系: 認証エラー（401 Unauthorized）の場合、自動的にトークンを再取得してリトライされる

---

### REQ-603: タイムアウト処理の受け入れ基準 🔵 *ユーザーヒアリング: 5秒以内の許容範囲*

**Given（前提条件）**:
- MCPサーバーが起動済み
- 認証が完了済み

**When（実行条件）**:
- API呼び出しが5秒以内に完了しない

**Then（期待結果）**:
- タイムアウトエラーが返却される
- エラーメッセージ「APIの応答がタイムアウトしました（5秒）。再試行してください」が表示される

**テストケース**:
- [ ] 異常系: API呼び出しが5秒を超えた場合、タイムアウトエラーが返却される
- [ ] 異常系: タイムアウト後、リソースが適切に解放される

---

## 非機能テスト基準

### パフォーマンステスト

**NFR-001: APIリクエストのレスポンス時間 🔵 *ユーザーヒアリング: 5秒以内*

- [ ] 応答時間: 各MCPツールのAPIリクエストが5秒以内に完了する
- [ ] スループット: 同時に複数のリクエストを処理できる（並列処理）
- [ ] リソース使用量: メモリ使用量が500MB以下である

**テスト方法**:
- 各MCPツールを10回実行し、平均レスポンス時間を計測
- 合格基準: 平均5秒以内、最大10秒以内

**NFR-002: 起動時認証処理の応答時間 🟡 *REQ-001から推測*

- [ ] 起動時間: MCPサーバー起動から認証完了まで10秒以内

**テスト方法**:
- MCPサーバーを10回起動し、認証完了までの時間を計測
- 合格基準: 平均10秒以内

---

### 可用性テスト

**NFR-101, NFR-102: エラー時の安定性 🔵 *教育目的・エラーハンドリング要件より*

- [ ] API接続失敗時も正常終了する（クラッシュしない）
- [ ] ネットワークエラー時にクラッシュしない
- [ ] エラー発生後も継続してリクエストを処理できる

**テスト方法**:
- ネットワークを意図的に切断して、各MCPツールを実行
- API応答を遅延させて、タイムアウトを発生させる
- 合格基準: 全てのケースでクラッシュせず、エラーメッセージが表示される

---

### 保守性テスト

**NFR-201: TypeScript strict modeによる型安全性 🔵 *tech-stack.md コード品質基準より*

- [ ] TypeScript strict modeが有効である
- [ ] 型エラーが0件である
- [ ] any型の使用が最小限に抑えられている

**テスト方法**:
- `npm run build`を実行し、型エラーが発生しないことを確認
- 合格基準: 型エラー0件

**NFR-202: ESLintによるコード品質 🔵 *tech-stack.md コード品質基準より*

- [ ] ESLintエラーが0件である
- [ ] コーディング規約に準拠している

**テスト方法**:
- `npm run lint`を実行し、ESLintエラーが発生しないことを確認
- 合格基準: ESLintエラー0件

**NFR-203: コメント・ドキュメントの充実 🔵 *tech-stack.md ドキュメント基準より*

- [ ] 複雑なロジックに適切なコメントが記載されている
- [ ] 各MCPツールにJSDocコメントが記載されている
- [ ] README.mdにセットアップ手順が記載されている

**テスト方法**:
- コードレビューで確認
- 合格基準: 主要な関数・クラスにコメントが記載されている

---

### ユーザビリティテスト

**NFR-301: 日本語エラーメッセージ 🔵 *ユーザーヒアリング + 日本向けプロジェクト*

- [ ] エラーメッセージが日本語で表示される
- [ ] エラーメッセージが分かりやすく、対処法が明確である

**テスト方法**:
- 意図的にエラーを発生させ、エラーメッセージを確認
- 合格基準: 全てのエラーメッセージが日本語で、対処法が明示されている

**NFR-302: MCPツール説明の日本語化 🟡 *日本向けプロジェクトから推測*

- [ ] 各MCPツールの説明が日本語で記載されている
- [ ] パラメータの説明が日本語で記載されている

**テスト方法**:
- Claude Desktop経由でMCPツール一覧を確認
- 合格基準: 全てのツール説明が日本語である

---

### セキュリティテスト

**REQ-1101, REQ-1102: APIキー管理 🔵 *REQUIREMENTS.md 8.2技術的制約より*

- [ ] APIキー・リフレッシュトークンが環境変数から読み込まれる
- [ ] `.env`ファイルが`.gitignore`に含まれている
- [ ] リポジトリに`.env`ファイルがコミットされていない

**テスト方法**:
- `git log`で`.env`ファイルの履歴を確認
- 合格基準: `.env`ファイルがリポジトリに含まれていない

**REQ-1103: 個人情報の非保持 🔵 *tech-stack.md セキュリティ方針より*

- [ ] システムが個人情報を保存していない
- [ ] ログファイルに個人情報が含まれていない

**テスト方法**:
- ログファイル・データファイルを確認
- 合格基準: 個人情報（氏名・住所・電話番号等）が含まれていない

---

## Edgeケーステスト基準

### EDGE-001: 存在しない銘柄コード 🟡 *バリデーション要件から推測*

**テストシナリオ**:
- 存在しない銘柄コード（例: "9999"）を指定してMCPツールを呼び出す

**合格基準**:
- [ ] 「指定された銘柄コード（9999）は存在しません」というエラーが表示される
- [ ] システムがクラッシュしない

---

### EDGE-002: 日付フォーマットエラー 🟡 *バリデーション要件から推測*

**テストシナリオ**:
- 不正な日付フォーマット（例: "2024/10/01"）を指定してMCPツールを呼び出す

**合格基準**:
- [ ] 「日付はYYYY-MM-DD形式で指定してください」というエラーが表示される
- [ ] システムがクラッシュしない

---

### EDGE-003: APIキー未設定 🔵 *REQ-1101から導出*

**テストシナリオ**:
- `.env`ファイルにAPIキーが未設定の状態でMCPサーバーを起動する

**合格基準**:
- [ ] 「環境変数 J_QUANTS_REFRESH_TOKEN を設定してください」というエラーが表示される
- [ ] システムが正常終了する

---

### EDGE-101: データ取得期間超過 🟡 *REQ-1202から推測*

**テストシナリオ**:
- 過去3年分の株価データを取得しようとする

**合格基準**:
- [ ] 過去2年分のみを取得する
- [ ] 「フリープランでは過去2年分のみ取得可能です」という警告メッセージが表示される

---

### EDGE-102: 取得開始日 > 取得終了日 🟡 *一般的なバリデーションから推測*

**テストシナリオ**:
- `from_date="2024-10-01"`, `to_date="2024-01-01"`と指定する

**合格基準**:
- [ ] 「取得開始日は取得終了日より前の日付を指定してください」というエラーが表示される

---

### EDGE-201: APIメンテナンス中 🟡 *REQ-602から推測*

**テストシナリオ**:
- J-Quants APIがメンテナンス中（503エラー）の状態でMCPツールを呼び出す

**合格基準**:
- [ ] 3回リトライされる
- [ ] 「J-Quants APIがメンテナンス中です。しばらく時間をおいてから再試行してください」というエラーが表示される

---

### EDGE-202: ネットワーク切断 🟡 *REQ-602から推測*

**テストシナリオ**:
- インターネット接続が切断された状態でMCPツールを呼び出す

**合格基準**:
- [ ] 「ネットワークに接続できません。インターネット接続を確認してください」というエラーが表示される
- [ ] システムがクラッシュしない

---

### EDGE-301: JSONパースエラー 🟡 *エラーハンドリングから推測*

**テストシナリオ**:
- APIレスポンスがJSONとしてパース不可能（例: HTML形式のエラーページ）

**合格基準**:
- [ ] 「APIレスポンスの形式が不正です」というエラーが表示される
- [ ] エラー詳細がログファイルに記録される

---

### EDGE-302: 必須フィールド欠如 🟡 *エラーハンドリングから推測*

**テストシナリオ**:
- APIレスポンスに必須フィールド（例: `code`, `name`）が欠けている

**合格基準**:
- [ ] 「APIレスポンスに必要なデータが含まれていません」というエラーが表示される
- [ ] エラー詳細がログファイルに記録される

---

## 統合テスト基準

### システム連携テスト

- [ ] J-Quants API連携: 全てのMCPツールがJ-Quants APIと正常に通信できる
- [ ] ファイルシステム: トークンキャッシュ（JSON）の読み書きが正常に動作する
- [ ] Claude Desktop連携: Claude Desktop経由でMCPツールが呼び出せる

**テスト方法**:
- Claude Desktopの設定ファイルにMCPサーバーを登録
- Claude経由で各MCPツールを呼び出し、正常に動作することを確認

---

## リグレッションテスト基準

### 既存機能影響確認

- [ ] 既存機能の動作確認: 新機能追加後も既存のMCPツールが正常に動作する
- [ ] パフォーマンス劣化確認: レスポンス時間が5秒以内を維持している
- [ ] エラーハンドリング確認: エラー時の動作が変更されていない

---

## 受け入れテスト実行チェックリスト

### テスト実行前

- [ ] テスト環境の準備完了（Node.js 20 LTS、npm）
- [ ] J-Quants APIフリープランに登録済み
- [ ] リフレッシュトークンを取得済み
- [ ] `.env`ファイルにリフレッシュトークンを設定済み
- [ ] 依存関係のインストール完了（`npm install`）
- [ ] ビルド成功（`npm run build`）

### テスト実行中

- [ ] 全機能テストの実行（REQ-001～REQ-1202）
- [ ] 全非機能テストの実行（NFR-001～NFR-401）
- [ ] 全Edgeケーステストの実行（EDGE-001～EDGE-302）
- [ ] 問題発見時の詳細記録（スクリーンショット・ログ）
- [ ] 修正後の再テスト

### テスト完了後

- [ ] テスト結果の記録（成功・失敗・保留）
- [ ] 残存問題の整理（Issue登録）
- [ ] 受け入れ可否の判定
  - Phase 1 MVP: 全ての🔵青信号テストが成功
  - Phase 2 拡張: 全ての🔵🟡テストが成功
  - Phase 3 高度な分析: 全てのテストが成功
- [ ] ステークホルダーへの報告

---

## Phase別受け入れ基準

### Phase 1 MVP 受け入れ基準

**必須テスト**:
- [ ] REQ-001～REQ-004: 認証機能
- [ ] REQ-101～REQ-102: get_listed_companies
- [ ] REQ-201～REQ-203: get_stock_price
- [ ] REQ-301～REQ-302: get_financial_statements
- [ ] REQ-401～REQ-402: get_company_info
- [ ] REQ-601～REQ-603: エラーハンドリング
- [ ] NFR-001～NFR-003: パフォーマンス
- [ ] NFR-201～NFR-203: 保守性

**合格基準**: 上記の全テストが成功すること

### Phase 2 拡張機能 受け入れ基準

**必須テスト**:
- Phase 1の全テスト
- [ ] 検索機能（search_companies）
- [ ] 配当情報（get_dividend_info）
- [ ] 取引カレンダー（get_trading_calendar）
- [ ] EDGE-001～EDGE-302: 全Edgeケース

**合格基準**: Phase 1 + 上記の全テストが成功すること

### Phase 3 高度な分析 受け入れ基準

**必須テスト**:
- Phase 1, 2の全テスト
- [ ] 信用取引残高（get_margin_trading）
- [ ] 空売り情報（get_short_selling）
- [ ] 投資部門別売買（get_investment_breakdown）
- [ ] TOPIX指数（get_topix_data）

**合格基準**: 全てのテストが成功すること

---

## 更新履歴

- 2025-10-29: 初版作成（kairo-requirements コマンドにより作成）
  - EARS要件定義に基づく受け入れ基準定義
  - Phase別テストケース作成
  - Edgeケーステスト基準定義
