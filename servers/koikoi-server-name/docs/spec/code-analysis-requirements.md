# コード解析MCP 要件定義書

## 概要

このドキュメントは、**Claude Codeのコンテキスト消費を削減**することを目的とした、効率的なコード解析MCPサーバーの要件を定義します。本サーバーは、ファイルの生の内容を全て送信する代わりに、必要な情報（関数構造、型定義、依存関係等）のみを抽出・構造化して提供します。

### プロジェクト情報
- **プロジェクト名**: koikoi-server-name（コード解析MCP）
- **プロジェクトタイプ**: MCPサーバー
- **開発期間**: プロトタイプ/MVP（1-2ヶ月）
- **技術スタック**: TypeScript 5.9.3, Bun 1.3.1, MCP SDK 1.18.1

### 主要な目的
1. **コンテキスト効率化**: ファイルの生内容を送信せず、構造化された情報のみを提供
2. **高速解析**: TypeScript Compiler APIを活用した正確な解析
3. **柔軟な詳細度**: 簡潔モード/詳細モードを切り替え可能
4. **Claude Code統合**: Claude Codeのワークフローに最適化

## 関連文書

- **ユーザストーリー**: [📖 code-analysis-user-stories.md](code-analysis-user-stories.md)
- **受け入れ基準**: [✅ code-analysis-acceptance-criteria.md](code-analysis-acceptance-criteria.md)
- **技術スタック**: [🚀 tech-stack.md](../tech-stack.md)

## 機能要件（EARS記法）

**【信頼性レベル凡例】**:
- 🔵 **青信号**: tech-stack.md・ユーザヒアリング（2025-10-29）を参考にした確実な要件
- 🟡 **黄信号**: tech-stack.md・ユーザヒアリングから妥当な推測による要件
- 🔴 **赤信号**: 既存資料にない推測による要件

### 通常要件（SHALL）

#### コード構造解析
- **REQ-001**: システムは、TypeScript/JavaScriptファイルから関数一覧を抽出しなければならない 🔵 *ユーザヒアリング2025-10-29（機能1）より*
- **REQ-002**: システムは、クラスとそのメソッド一覧を抽出しなければならない 🔵 *ユーザヒアリング2025-10-29（機能1）より*
- **REQ-003**: システムは、各関数/メソッドのシグネチャ（引数、戻り値の型）を抽出しなければならない 🔵 *ユーザヒアリング2025-10-29（機能1）より*
- **REQ-004**: システムは、関数/メソッドのアクセス修飾子（public/private/protected）を識別しなければならない 🟡 *コード構造解析の妥当な推測*
- **REQ-005**: システムは、エクスポートされた関数/クラスを識別しなければならない 🟡 *コード構造解析の妥当な推測*

#### シンボル検索
- **REQ-011**: システムは、指定されたシンボル名（関数名、クラス名、変数名）の定義位置を検索する機能を提供しなければならない 🔵 *ユーザヒアリング2025-10-29（機能2）より*
- **REQ-012**: システムは、検索結果にファイルパスと行番号を含めなければならない 🔵 *ユーザヒアリング2025-10-29（機能2）より*
- **REQ-013**: システムは、複数ファイルにわたるシンボル検索をサポートしなければならない 🔵 *ユーザヒアリング2025-10-29（機能2）より*
- **REQ-014**: システムは、部分一致検索（前方一致、後方一致）をサポートしなければならない 🟡 *シンボル検索の妥当な推測*

#### 依存関係解析
- **REQ-021**: システムは、ファイルのimport文を解析し、依存ライブラリの一覧を抽出しなければならない 🔵 *ユーザヒアリング2025-10-29（機能3）より*
- **REQ-022**: システムは、内部モジュールと外部ライブラリを区別しなければならない 🟡 *依存関係解析の妥当な推測*
- **REQ-023**: システムは、動的import（`import()`）も検出しなければならない 🟡 *依存関係解析の妥当な推測*
- **REQ-024**: システムは、re-export（`export { ... } from`）も解析しなければならない 🟡 *依存関係解析の妥当な推測*

#### ファイルサマリー
- **REQ-031**: システムは、ファイル全体の目的を要約する機能を提供しなければならない 🔵 *ユーザヒアリング2025-10-29（機能4）より*
- **REQ-032**: システムは、ファイルの主要な機能（エクスポート関数/クラス）をリストアップしなければならない 🔵 *ユーザヒアリング2025-10-29（機能4）より*
- **REQ-033**: システムは、ファイルの役割（ユーティリティ、コンポーネント、型定義等）を推測しなければならない 🟡 *ファイルサマリーの妥当な推測*

#### 型情報抽出
- **REQ-041**: システムは、TypeScriptのinterface定義を抽出しなければならない 🔵 *ユーザヒアリング2025-10-29（機能5）より*
- **REQ-042**: システムは、type alias定義を抽出しなければならない 🔵 *ユーザヒアリング2025-10-29（機能5）より*
- **REQ-043**: システムは、enum定義を抽出しなければならない 🔵 *ユーザヒアリング2025-10-29（機能5）より*
- **REQ-044**: システムは、各型のプロパティとその型情報を含めなければならない 🔵 *ユーザヒアリング2025-10-29（機能5）より*
- **REQ-045**: システムは、ジェネリック型パラメータも抽出しなければならない 🟡 *型情報抽出の妥当な推測*

#### ドキュメント抽出
- **REQ-051**: システムは、関数/クラスのJSDocコメントを抽出しなければならない 🔵 *ユーザヒアリング2025-10-29（機能6）より*
- **REQ-052**: システムは、`@param`、`@returns`、`@throws`等のJSDocタグを解析しなければならない 🔵 *ユーザヒアリング2025-10-29（機能6）より*
- **REQ-053**: システムは、インラインコメント（`//`、`/* */`）も抽出できなければならない 🔵 *ユーザヒアリング2025-10-29（機能6）より*
- **REQ-054**: システムは、非推奨（`@deprecated`）マーカーを識別しなければならない 🟡 *ドキュメント抽出の妥当な推測*

#### 出力形式
- **REQ-061**: システムは、解析結果を構造化されたJSON形式で返さなければならない 🔵 *ユーザヒアリング2025-10-29（質問3）より*
- **REQ-062**: システムは、簡潔モードと詳細モードを切り替えられなければならない 🔵 *ユーザヒアリング2025-10-29（質問4）より*
- **REQ-063**: システムは、簡潔モードではシグネチャと要約のみを含めなければならない 🔵 *ユーザヒアリング2025-10-29（質問4）より*
- **REQ-064**: システムは、詳細モードでは関数本体の一部や詳細なコメントも含めなければならない 🔵 *ユーザヒアリング2025-10-29（質問4）より*

### 条件付き要件（WHEN/IF-THEN）

#### エラーハンドリング
- **REQ-101**: 解析中にエラーが発生した場合、システムは部分的に成功した結果を返さなければならない 🔵 *ユーザヒアリング2025-10-29（質問8）より*
- **REQ-102**: 構文エラーのあるファイルの場合、システムは解析可能な部分のみを返し、エラー情報を併記しなければならない 🔵 *ユーザヒアリング2025-10-29（質問8）より*
- **REQ-103**: 解析に失敗した場合でも、システムはファイルの基本情報（サイズ、行数）をフォールバックとして返さなければならない 🔵 *ユーザヒアリング2025-10-29（質問8）より*
- **REQ-104**: 複数ファイルの解析中にエラーが発生した場合、システムは他のファイルの解析を継続しなければならない 🔵 *ユーザヒアリング2025-10-29（質問8）より*

#### パフォーマンス最適化
- **REQ-111**: ファイルが変更されていない場合、システムはキャッシュされた解析結果を返さなければならない 🔵 *ユーザヒアリング2025-10-29（質問6）より*
- **REQ-112**: ファイルが部分的に変更された場合、システムは変更部分のみを再解析しなければならない 🔵 *ユーザヒアリング2025-10-29（質問6）より*
- **REQ-113**: 複数ファイルの解析要求を受けた場合、システムは並行処理で効率的に処理しなければならない 🔵 *ユーザヒアリング2025-10-29（質問6）より*
- **REQ-114**: 大規模プロジェクトの場合、システムは必要になったファイルのみを解析しなければならない 🟡 *パフォーマンス最適化の妥当な推測*

#### セキュリティ・アクセス制御
- **REQ-121**: Claude Codeのワークスペース外のファイルへアクセスが要求された場合、システムは適切なエラーを返さなければならない 🔵 *ユーザヒアリング2025-10-29（質問7）より*
- **REQ-122**: システムは、Claude Codeから提供されるワークスペース設定を尊重しなければならない 🔵 *ユーザヒアリング2025-10-29（質問7）より*

### 状態要件（WHERE）

- **REQ-201**: MCPサーバーが起動状態にある場合、システムはTypeScript Compilerを初期化し、解析準備を整えなければならない 🔵 *tech-stack.mdより*
- **REQ-202**: キャッシュが有効化されている状態の場合、システムはファイルの更新日時を監視し、キャッシュを適切に無効化しなければならない 🟡 *キャッシュ管理の妥当な推測*
- **REQ-203**: 開発モードで実行されている場合、システムは詳細なデバッグログを出力してもよい 🟡 *開発効率の妥当な推測*

### オプション要件（MAY）

- **REQ-301**: システムは、Markdown ファイルの構造（見出し、リスト）を解析してもよい 🔵 *ユーザヒアリング2025-10-29（質問2、将来対応）より*
- **REQ-302**: システムは、JSON/YAML ファイルの構造を解析してもよい 🔵 *ユーザヒアリング2025-10-29（質問2、将来対応）より*
- **REQ-303**: システムは、HTML/CSS ファイルの構造を解析してもよい 🔵 *ユーザヒアリング2025-10-29（質問2、将来対応）より*
- **REQ-304**: システムは、コールグラフ（関数の呼び出し関係）を生成してもよい 🔴 *既存資料にない推測*
- **REQ-305**: システムは、未使用の関数やimportを検出してもよい 🔴 *既存資料にない推測*

### 制約要件（MUST）

- **REQ-401**: システムは、TypeScript strict モードで実装されなければならない 🔵 *tech-stack.md・ユーザヒアリング2025-10-29より*
- **REQ-402**: システムは、MCP SDK 1.18.1 を使用して実装されなければならない 🔵 *tech-stack.mdより*
- **REQ-403**: システムは、Bun 1.3.1 ランタイムで動作しなければならない 🔵 *tech-stack.mdより*
- **REQ-404**: システムは、TypeScript Compiler API を使用して解析を実行しなければならない 🟡 *TypeScript解析の妥当な推測*
- **REQ-405**: システムは、プロトタイプ段階（1-2ヶ月）で全6機能を実装完了しなければならない 🔵 *ユーザヒアリング2025-10-29（質問9、全機能同等）より*

## 非機能要件

### パフォーマンス

- **NFR-001**: システムの起動時間は1秒以内でなければならない 🔵 *tech-stack.mdより*
- **NFR-002**: 小規模ファイル（100行以下）の解析時間は50ms以内でなければならない 🟡 *コンテキスト効率化の妥当な推測*
- **NFR-003**: 中規模ファイル（1000行以下）の解析時間は200ms以内でなければならない 🟡 *コンテキスト効率化の妥当な推測*
- **NFR-004**: 大規模ファイル（5000行以上）の解析時間は1秒以内でなければならない 🟡 *コンテキスト効率化の妥当な推測*
- **NFR-005**: キャッシュヒット時の応答時間は10ms以内でなければならない 🟡 *キャッシュ性能の妥当な推測*
- **NFR-006**: 10個のファイルの並行解析が2秒以内に完了しなければならない 🟡 *並行処理の妥当な推測*

### コンテキスト効率

- **NFR-101**: 簡潔モードの出力サイズは、元ファイルサイズの10%以下でなければならない 🔵 *ユーザヒアリング2025-10-29（目的）より*
- **NFR-102**: 詳細モードの出力サイズは、元ファイルサイズの30%以下でなければならない 🔵 *ユーザヒアリング2025-10-29（目的）より*
- **NFR-103**: 1000行のファイルの簡潔モード出力は、100行相当以下でなければならない 🟡 *コンテキスト効率化の妥当な推測*

### 品質・テスト

- **NFR-201**: システムは、主要機能の単体テストを実装しなければならない 🔵 *tech-stack.md・ユーザヒアリング2025-10-29より*
- **NFR-202**: システムは、正常系・異常系・境界値のテストケースを含まなければならない 🔵 *tech-stack.mdより*
- **NFR-203**: システムは、実際のTypeScript/JavaScriptファイルを使用した統合テストを含まなければならない 🟡 *テスト品質の妥当な推測*
- **NFR-204**: システムのテストカバレッジは、主要機能で70%以上でなければならない 🟡 *tech-stack.mdから妥当な推測*

### 保守性・拡張性

- **NFR-301**: システムは、各解析機能を独立したモジュールとして実装しなければならない 🟡 *tech-stack.md（ディレクトリ構造）から妥当な推測*
- **NFR-302**: システムは、新しいファイルタイプの解析を容易に追加できる設計でなければならない 🔵 *ユーザヒアリング2025-10-29（質問2、将来対応）より*
- **NFR-303**: システムは、TypeScript の型定義を活用して、インターフェースを明確にしなければならない 🔵 *tech-stack.mdより*

### ユーザビリティ

- **NFR-401**: システムは、エラーメッセージに解析できなかった理由を含めなければならない 🔵 *ユーザヒアリング2025-10-29（質問8）より*
- **NFR-402**: システムは、部分的な成功の場合、成功した部分と失敗した部分を明確に区別しなければならない 🔵 *ユーザヒアリング2025-10-29（質問8）より*
- **NFR-403**: システムは、JSON出力にスキーマ情報を含め、Claude Codeが構造を理解しやすくしなければならない 🟡 *ユーザビリティの妥当な推測*

## Edgeケース

### エラー処理

- **EDGE-001**: TypeScriptの構文エラーがある場合でも、システムは解析可能な部分（import文、型定義等）を返さなければならない 🔵 *ユーザヒアリング2025-10-29（質問8）より*
- **EDGE-002**: ファイルの文字エンコーディングが不正な場合、システムは適切なエラーメッセージを返さなければならない 🟡 *エラーハンドリングの妥当な推測*
- **EDGE-003**: 循環依存が検出された場合、システムは警告を含めて結果を返さなければならない 🟡 *依存関係解析の妥当な推測*

### 境界値

- **EDGE-101**: 空のファイル（0バイト）の解析が正しく動作しなければならない 🟡 *境界値の妥当な推測*
- **EDGE-102**: 非常に大きなファイル（10,000行以上）でもメモリエラーが発生してはならない 🟡 *境界値の妥当な推測*
- **EDGE-103**: コメントのみのファイルでも適切に処理されなければならない 🟡 *境界値の妥当な推測*

### 特殊なTypeScript構文

- **EDGE-201**: 型ガード（type guards）を正しく解析しなければならない 🟡 *TypeScript特有の妥当な推測*
- **EDGE-202**: Mapped Types や Conditional Types を正しく解析しなければならない 🟡 *TypeScript特有の妥当な推測*
- **EDGE-203**: JSX/TSX ファイルを正しく解析しなければならない 🟡 *React対応の妥当な推測*

## MVP優先度

### Phase 1（MVP - 1-2ヶ月）

**全機能を同等の優先度で実装** 🔵 *ユーザヒアリング2025-10-29（質問9）より*

**Must Have（必須機能）**:
- ✅ コード構造解析（REQ-001〜REQ-005）
- ✅ シンボル検索（REQ-011〜REQ-014）
- ✅ 依存関係解析（REQ-021〜REQ-024）
- ✅ ファイルサマリー（REQ-031〜REQ-033）
- ✅ 型情報抽出（REQ-041〜REQ-045）
- ✅ ドキュメント抽出（REQ-051〜REQ-054）
- ✅ 簡潔モード/詳細モード切り替え（REQ-061〜REQ-064）
- ✅ エラーハンドリング（REQ-101〜REQ-104）
- ✅ キャッシュ機能（REQ-111）
- ✅ 基本的なテスト（NFR-201〜NFR-202）

**Should Have（重要だが必須ではない）**:
- ⭐ 増分解析（REQ-112）
- ⭐ 並行処理（REQ-113）
- ⭐ 統合テスト（NFR-203）

### Phase 2（機能拡張 - 2-3ヶ月目）

**Could Have（あれば良い）**:
- 📋 Markdown ファイル解析（REQ-301）
- 📋 JSON/YAML ファイル解析（REQ-302）
- 📋 HTML/CSS ファイル解析（REQ-303）
- 📋 コールグラフ生成（REQ-304）
- 📋 未使用コード検出（REQ-305）
- 📋 パフォーマンス最適化の深化

### Phase 3（本番化 - 3ヶ月目以降）

**Won't Have（今回は対象外）**:
- ❌ Python、Go等の他言語対応
- ❌ リアルタイムファイル監視
- ❌ IDE統合（LSP等）

## ツール定義

システムは、以下のMCPツールを提供します：

### 1. analyze_file
**説明**: 単一ファイルを解析し、構造化された情報を返す

**入力パラメータ**:
```typescript
{
  path: string;              // ファイルパス
  mode?: "concise" | "detailed";  // 簡潔モード/詳細モード（デフォルト: concise）
  include?: string[];        // 含める情報（例: ["structure", "types", "docs"]）
}
```

**出力形式**:
```typescript
{
  file: {
    path: string;
    size: number;
    lines: number;
  };
  summary: string;           // ファイルの要約
  exports: Export[];         // エクスポートされた関数/クラス
  imports: Import[];         // import文の一覧
  functions: Function[];     // 関数一覧
  classes: Class[];          // クラス一覧
  types: TypeDefinition[];   // 型定義一覧
  enums: EnumDefinition[];   // enum定義一覧
  errors?: ParseError[];     // 解析エラー（あれば）
}
```

### 2. search_symbol
**説明**: プロジェクト内でシンボルを検索

**入力パラメータ**:
```typescript
{
  symbol: string;            // 検索するシンボル名
  type?: "function" | "class" | "type" | "variable" | "all";
  matchType?: "exact" | "prefix" | "suffix" | "contains";
}
```

**出力形式**:
```typescript
{
  results: Array<{
    symbol: string;
    type: string;
    file: string;
    line: number;
    column: number;
    signature?: string;      // 関数/メソッドの場合
  }>;
}
```

### 3. analyze_project
**説明**: プロジェクト全体の構造を解析

**入力パラメータ**:
```typescript
{
  rootPath: string;          // プロジェクトルートパス
  includePatterns?: string[]; // 含めるファイルパターン（デフォルト: ["**/*.ts", "**/*.tsx", "**/*.js", "**/*.jsx"]）
  excludePatterns?: string[]; // 除外するパターン（デフォルト: ["node_modules/**", "dist/**"]）
  mode?: "concise" | "detailed";
}
```

**出力形式**:
```typescript
{
  project: {
    totalFiles: number;
    totalLines: number;
  };
  summary: string;           // プロジェクト全体の要約
  structure: FileNode[];     // ディレクトリ構造
  dependencies: {
    external: string[];      // 外部ライブラリ
    internal: string[];      // 内部モジュール
  };
  exports: {
    [fileName: string]: Export[];
  };
}
```

### 4. get_dependencies
**説明**: ファイルの依存関係を取得

**入力パラメータ**:
```typescript
{
  path: string;              // ファイルパス
  depth?: number;            // 依存関係の深さ（デフォルト: 1）
}
```

**出力形式**:
```typescript
{
  file: string;
  imports: Array<{
    source: string;
    type: "external" | "internal";
    imported: string[];      // インポートされたシンボル
  }>;
  dependents?: string[];     // このファイルに依存しているファイル
}
```

## JSON出力スキーマ

詳細な型定義については、実装時に `src/types/analysis.ts` で定義します。

主要な型：
- `FileAnalysis`: ファイル解析結果
- `Function`: 関数情報
- `Class`: クラス情報
- `TypeDefinition`: 型定義情報
- `Export`: エクスポート情報
- `Import`: インポート情報

## 更新履歴

- **2025-10-29**: 初回作成（ユーザヒアリング2025-10-29に基づく）
  - 目的: Claude Codeのコンテキスト節約
  - 6つの主要解析機能（全て同等優先度）
  - TypeScript/JavaScript対応（MVP）
  - 構造化JSON出力
  - キャッシュ・増分解析・並行処理対応
  - Claude Codeワークスペース連携
